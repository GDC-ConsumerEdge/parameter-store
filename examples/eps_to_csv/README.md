# EPS to CSV Converter

This set of script and configuration is designed to fetch cluster data from an EPS API and generate CSV files suitable for use as Source of Truth (SoT) data, specifically for cluster intent and cluster template data.

## Purpose

The primary goal is to automate the retrieval and transformation of cluster information from an EPS system into standardized CSV formats. These CSV files can then be used for potential integrations with HRM, Cluster Provisioner and other tools that use GitOps workflows.

## Components

### Credentials Setup

The script requires Google Cloud [Application Default Credentials](https://cloud.google.com/docs/authentication/application-default-credentials) through :
* A service Account credentials file (`GOOGLE_APPLICATION_CREDENTIALS` env variable to be set to the path of Service Account credentials)
* Run from a Workload Identity Federated location (which sets up `GOOGLE_APPLICATION_CREDENTIALS` for you eg: GitHub Actions)
* If gcloud SDK is installed, the credentials generated by `gcloud auth application-default login --impersonate-service-account`
* The attached service account returned by the metadata server if run from Compute Engine, Cloud Run

### Required Environment Variables

*   EPS\_CLIENT\_ID: The [OAuth 2.0 Client ID](https://console.cloud.google.com/auth/clients) associated with the IAP protecting the EPS API. The script uses this as the audience when generating the ID token.
    
*   EPS\_HOST: The hostname of the EPS API (e.g., eps.example.com). This could be a FQDN or an IP address only.
    
*   SERVICE\_ACCOUNT: The email address of the Google Service Account that the script will impersonate to generate the ID token for IAP.
    
*   GOOGLE\_APPLICATION\_CREDENTIALS: Path to the Google Cloud credentials file. This file should contain credentials that have permission to impersonate the target SERVICE\_ACCOUNT specified above (see Permissions section). This could be a Workload Identity Federation credential file when run in GitHub Actions or a standard service account key file for local execution (though using Workload Identity is generally preferred).
    
*   OUTPUT\_INTENT\_CSV (Optional): Overrides the default output path for the intent CSV (cluster\_intent\_sot.csv). Used when the -intent flag is passed.
    
*   OUTPUT\_DATA\_CSV (Optional): Overrides the default output path for the data CSV (source\_of\_truth.csv). Used when the -data flag is passed.
    
*   LOG\_LEVEL (Optional): Sets the logging level (e.g., DEBUG, INFO, WARNING). Defaults to INFO.

### Configuration File (`config.ini`)

This file defines the structure and renaming rules for the output CSV files.

* **`[sot_columns]`**: Specifies the exact column names expected in the final CSVs for both `cluster_intent_sot` and `cluster_data_sot`. These names should align with the data structure in the EPS system. If the columns are to be generated with different names to that of EPS, please specify them explicitly in `rename_columns` below.
* **`[rename_columns]`**: Defines rules for renaming columns fetched from the EPS API to the desired names in the processed DataFrame before CSV generation (e.g., `name = cluster_name`.. This would fetch the cluster attribute `name` from EPS and generate the data under the csv column `cluster_name` ).

### Main Conversion Script (`eps_to_csv_converter.py`)

This Python script orchestrates the entire process:

* **Loads Configuration**: Reads column definitions and renaming rules from `config.ini`.
* **Retrieves Parameters**: Fetches necessary API details (Client ID, Host, Service Account) from environment variables.
* **Authenticates & Fetches Data**:
    * Uses Google Cloud IAM Credentials and Identity-Aware Proxy (IAP) to securely authenticate using a service account.
    * Makes a GET request to the EPS API endpoint (`/api/v1/clusters`) to retrieve cluster data in JSON format.
* **Processes Data**:
    * Flattens the nested JSON response from the API into a Pandas DataFrame.
    * Removes specified prefixes (like `data_`, `intent_`) from flattened column names.
    * Handles potential duplicate column names arising from prefix removal.
    * Applies the specific column renaming rules defined in `config.ini`.
* **Generates CSVs**:
    * Based on command-line arguments (`-intent` or `-data`), it selects the appropriate columns (defined in `config.ini`).
    * Writes the selected data to the target CSV file (`cluster_intent_sot.csv` or `source_of_truth.csv` by default, but configurable via environment variables `OUTPUT_INTENT_CSV` and `OUTPUT_DATA_CSV`).

### Install Dependencies

These can be installed from the utils directory using : 

``` pip install -r requirements.txt```

### Usage

The script accepts flags to determine which CSV to generate:

```bash
# Generate Cluster Intent SoT
python .github/resources/eps_to_csv_converter.py -intent

# Generate Cluster Data SoT
python .github/resources/eps_to_csv_converter.py -data

# Generate both
python .github/resources/eps_to_csv_converter.py -intent -data

```

Authentication and Permissions
------------------------------

### Service Account (SERVICE\_ACCOUNT) Permissions:

The Google Service Account specified by the `SERVICE_ACCOUNT` environment variable needs the following permissions:

1.  **IAM Permissions**:
    
    *   `iam.serviceAccounts.getOpenIdToken` (typically included in the `Service Account Token Creator role : roles/iam.serviceAccountTokenCreator`). This permission is required for the generate\_id\_token call made by the script. The principal running the script (e.g., the GitHub Actions workflow identity or the user running it locally) needs to have this role on the target SERVICE\_ACCOUNT.
        
2.  **IAP Permissions**:
    
    *   The service account needs to be granted access to the IAP-protected EPS API. This is typically done by adding the service account email to the `IAP-secured Web App User` role (roles/iap.httpsResourceAccessor) on the IAP configuration for the backend service hosting the EPS API.

If a User Identity is used to generate the application default credentials : 

1. * The user identity should have the following permissions on the impersonated service Account :
     * Service Account Token Creator (roles/iam.serviceAccountTokenCreator)
